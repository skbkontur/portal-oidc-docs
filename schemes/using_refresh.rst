
Обновление Access Token
=======================

Access Token — токен доступа, с которым ваше приложение может отправлять запросы в API Продуктов Контура. Время жизни токена 24 часа. По истечении этого времени ваше приложение может:

1. :doc:`инициировать авторизацию</schemes/auth_and_authorize>`, в которой пользователь должен заново выдать разрешение на доступ к данным. В этом случае OpenID Провайдер выдаст приложению новые токены;
2. :ref:`использовать Refresh Token<rst-murkup-using-refresh>` для продления уже выданного Access Token с текущими разрешениями без участия пользователя.  

.. note:: Refresh Token может получить только приложение с бэкендом при :ref:`получении токенов через код подтверждения<rst-murkup-authorize_by_code>`.

В каких случаях вам нужно использовать Refresh Token:

1. Если ваше приложение выполняет запросы в API от имени пользователя в фоновом режиме.
2. Если вы не хотите при каждом обновлении токенов перенаправлять пользователя в браузере на OpenID Провайдер. 

.. _rst-murkup-using-refresh: 

Использование Refresh Token для продления Access Token
------------------------------------------------------

.. important:: Если вы хотите реализовать данную схему продления Access Token, вам нужно получить разрешения на получение и использование Refresh Token. Для этого напишите нам на portal.team@skbkontur.ru и опишите ваш сценарий.

Используя Refresh Token можно получить новый Access Token. Для этого нужно отправить запрос с бэкенда в Token Endpoint.

При этом по умолчанию создается новый Refresh Token. Использование Refresh Token не влияет на Access Token, с которым он получен.

.. rubric:: Параметры запроса Token Endpoint

Все параметры типа string.

.. |br| raw:: html

    <br />

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | grant_type         | Обязательный параметр. |br|                                                      |
    |                    | Способ запроса токена. Укажите значение ``refresh_token``                        |
    +--------------------+----------------------------------------------------------------------------------+
    | client_id          | Обязательный параметр. |br|                                                      |
    |                    | Идентификатор приложения, выдается при регистрации приложения.                   |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | client_secret      | Обязательный параметр. |br|                                                      |
    |                    | Ключ приложения, выдается при регистрации приложения.                            |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | refresh_token      | Обязательный параметр. |br|                                                      |
    |                    | Токен, полученный в предыдущем запросе к Token Endpoint                          |
    +--------------------+----------------------------------------------------------------------------------+

**Пример запроса**

::

    POST /token
    Content-type: application/x-www-form-urlencoded

    grant_type=refresh_token
    &client_id=yourClientId
    &client_secret=yourClientSecret
    &refresh_token=1487e3f7ce5aea612e2d7727ded76ad574e30643046ae2c247ae9c94c6b61e71


.. rubric::  Параметры ответа Token Endpoint

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | access_token       | Access Token можно использовать для обращения к UserInfo Endpoint                |
    +--------------------+----------------------------------------------------------------------------------+
    | token_type         | Тип токена. Всегда возвращает значение ``Bearer``                                |
    +--------------------+----------------------------------------------------------------------------------+
    | refresh_token      | Новый Refresh Token для обновления Access Token                                  |
    +--------------------+----------------------------------------------------------------------------------+
    | expires_in         | Время жизни Access Token в секундах                                              |
    +--------------------+----------------------------------------------------------------------------------+

.. rubric:: Возможные ошибки Token Endpoint

.. table::

    +-----+------------------------+----------------------------------------------------------------------------+
    | Код | Название ошибки        | Описание                                                                   |
    +=====+========================+============================================================================+
    | 400 | invalid_client         | * Параметр client_secret или client_id не передан;                         |
    |     |                        | * Параметр client_secret или client_id превышает 300 символов              |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | invalid_request        | * Параметр refresh_token не передан                                        |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | unsupported_grant_type | * Параметр grant_type не передан;                                          |
    |     |                        | * Переданный grant_type не существует;                                     |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | invalid_grant          | * Время жизни переданного refresh_token истекло;                           |
    |     |                        | * Переданный refresh_token не существует;                                  |
    |     |                        | * Пользователь, на которого выдан токен, удален;                           |
    |     |                        | * Пользователь отозвал права у приложения, токен отозван;                  |
    |     |                        | * Для указанного клиента client_id запрещен переданный grant_type;         |
    |     |                        |                                                                            |
    |     |                        | Если вы хотите использовать refresh_token, напишите нам |br|               |
    |     |                        | на portal.team@skbkontur.ru и опишите ваш сценарий.                        |
    +-----+------------------------+----------------------------------------------------------------------------+

**Пример ответа**

::

    200 OK
    Content-type: application/json

    {
        "access_token": "811d583cf85deb7ab67bd91b96a9a4bafb63d6a062d7dd72f81601b84c19dc40",
        "expires_in": 86400,
        "token_type": "Bearer",
        "refresh_token": "fd672752f8e9c4a8eb083fb2375b3126ae37dc69a0cf46953ef9a6e3f5a692df"
    }