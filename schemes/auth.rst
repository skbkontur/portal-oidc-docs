.. _`RFC Authorization Code Flow`: https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth
.. _`RFC Implicit Flow`: https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth
.. _`страницу входа`: https://auth.kontur.ru/

Аутентификация в приложении
===========================

Данный сценарий предполагает, что для аутентификации в вашем приложении пользователь использует учетную запись Контура. Чтобы узнать пользователя и информацию о нем, вашему приложению нужно получить у OpenID Провайдера Id Token. В этой статье описаны схемы интеграции, следуя алгоритму которых, ваше приложение получит Id Token пользователя и аутентифицирует его.

Реализовать получение токена можно одним из двух способов, выбор которого зависит от типа вашего приложения:

* `Получение токена через код подтверждения`_ для приложений с бэкендом,
* `Получение токена из URL`_ для приложений без бэкенда.

Получение токена через код подтверждения 
----------------------------------------

см. в `RFC Authorization Code Flow`_

Схема подходит для приложений с серверной частью. Пользователь для входа в ваше приложение использует учетную запись Контура. 

На схеме ниже показаны основные этапы входа в приложение. Каждый этап описан в алгоритме. 

.. image:: /_static/authentication_by_code.JPG

**Алгоритм получения токена через код подтверждения**

Чтобы инициировать аутентификацию в приложении должна быть кнопка/ссылка "Войти".

1. Пользователь входит в приложение.

2. Приложение направляет пользователя на OpenID Провайдер. Для этого нужно перенаправить пользователя на Authorization Endpoint.

.. rubric:: Параметры Authorization Endpoint

Все параметры типа string.

.. |br| raw:: html

    <br />

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | response_type      | Обязательный параметр. |br|                                                      |
    |                    | Ответ, который нужно получить от OpenID Провайдера. |br|                         |
    |                    | При запросе кода подтверждения указать значение ``code``                         |
    +--------------------+----------------------------------------------------------------------------------+
    | client_id          | Обязательный параметр. |br|                                                      |
    |                    | Идентификатор приложения, выдается при регистрации приложения                    |
    +--------------------+----------------------------------------------------------------------------------+
    | scope              | Обязательный параметр. |br|                                                      |
    |                    | Список прав доступа, которые необходимы приложению в текущей сессии. |br|        |
    |                    | Разделяются пробелом.                                                            |
    |                    |                                                                                  |
    |                    | * openid — обязательный scope для аутентификации. |br|                           |
    |                    |                                                                                  |
    |                    | Данный скоуп предполагает получение в ответ от OpenID Провайдера Id Token. |br|  |
    |                    |                                                                                  |
    |                    | Вместе со скоупом openid вы можете передать:                                     |
    |                    |                                                                                  |
    |                    | * profile;                                                                       |
    |                    | * email;                                                                         |
    |                    | * phone.                                                                         |
    |                    |                                                                                  |
    |                    | Описание данных скоупов, а также полный список прав доступов |br|                |
    |                    | см. в :ref:`Терминах и определениях<rst-murkup-scope>`. |br|                     |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | redirect_uri       | Обязательный параметр. |br|                                                      |
    |                    | URL, на который нужно перенаправить пользователя после того, как он |br|         |
    |                    | аутентифицировался. |br|                                                         |
    |                    | |br|                                                                             |
    |                    | Адрес URL, который будет передан в данном параметре, нужно обязательно |br|      |
    |                    | указать при :ref:`регистрации приложения<rst-murkup-registration>`               |
    |                    | до выполнения запроса.  |br|                                                     |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 400                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | nonce              | Обязательный параметр. |br|                                                      |
    |                    | Строка для удостоверения, что сессия клиента связана именно с вернувшимся |br|   |
    |                    | Id Token, и для предотвращения атак повторного воспроизведения.  |br|            |
    |                    | Данная строка вернется обратно клиенту внутри Id Token в п.7. |br|               |
    |                    | |br|                                                                             |
    |                    | Использование nonce позволит вам проверить подлинность информации, |br|          |
    |                    | которую вы получите в Id Token от OpenID Провайдера.                             |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | state              | Необязательный параметр.  |br|                                                   |
    |                    | Строка состояния. Параметр state служит для передачи пользовательского |br|      |
    |                    | контекста. |br|                                                                  |
    |                    | |br|                                                                             |
    |                    | State вернется без изменений обратно клиенту вместе с кодом подтверждения  |br|  |
    |                    | в п.4. Таким образом, вы можете сохранить данные и состояние |br|                |
    |                    | пользователя, созданные до, и  восстановить их после аутентификации. |br|        |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 1500                                      |
    +--------------------+----------------------------------------------------------------------------------+

**Пример запроса**

:: 

    https://identity.testkontur.ru/authorize?
    response_type=code
    &scope=openid email phone
    &client_id=yourClientId
    &redirect_uri=http://client.example.com/
    &state=af0ifjsldkj
    &nonce=n-0S6_WzA2Mj

3. OpenID Провайдер перенаправляет пользователя на `страницу входа`_, где он входит в существующую учетную запись или регистрирует новую.

4. OpenID Провайдер перенаправляет пользователя на адрес, указанный в поле ``redirect_uri``. В URL перенаправления будет передан код подтверждения. Если код подтверждения выдать не удалось, то OpenID Провайдер передаст в URL код ошибки и ее описание. 

.. note:: Есть такие ошибки, которые пользователь увидит в браузере, но они не вернутся приложению в ответе от Authorization Endpoint. Для пользователя на этом закончится сценарий аутентификации. OpenID Провайдер не будет перенаправлять его на redirect_uri. Примеры и описание на странице :doc:`/schemes/user_errors`.

.. rubric:: Данные в возвращаемом URL

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | state              | Строка состояния, которую OpenID Провайдер возвращает без изменения              |
    +--------------------+----------------------------------------------------------------------------------+
    | code               | Код подтверждения, который можно обменять на Id Token.                           |
    |                    |                                                                                  |
    |                    | **Время жизни кода — 5 минут**. Если он истек, нужно заново перенаправить |br|   |
    |                    | пользователя на Authorization Endpoint, см. п.2.                                 |
    +--------------------+----------------------------------------------------------------------------------+
    | error              | Ошибка аутентификации **access_denied**. Возвращается вместо кода |br|           |
    |                    | подтверждения, если пользователь или сервер по какой-то причине не выдал |br|    |
    |                    | разрешение на доступ к данным                                                    |
    +--------------------+----------------------------------------------------------------------------------+
    | error_description  | Описание ошибки                                                                  |
    +--------------------+----------------------------------------------------------------------------------+

**Пример ответа с кодом подтверждения**

::

    HTTP/1.1 302 Found
    Location: https://client.example.com?
    code=SplxlOBeZQQYbYS6WxSbIA
    &state=af0ifjsldkj

**Пример ответа с ошибкой**

::

    HTTP/1.1 302 Found
    Location: https://client.example.com?
    error=access_denied
    &state=af0ifjsldkj

5. Фронтенд извлекает код подтверждения из URL и передает его на бэкенд. 

6. Бэкенд приложения запрашивает Id Token в обмен на код подтверждения. Для этого нужно выполнить запрос в Token Endpoint.

.. rubric:: Параметры запроса Token Endpoint

Все параметры типа string.

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | grant_type         | Обязательный параметр. |br|                                                      |
    |                    | Способ запроса токена. Укажите значение ``authorization_code``                   |
    +--------------------+----------------------------------------------------------------------------------+
    | authorization_code | Обязательный параметр. |br|                                                      |
    |                    | Код подтверждения, полученный в запросе аутентификации п.4                       |
    +--------------------+----------------------------------------------------------------------------------+
    | client_id          | Обязательный параметр. |br|                                                      |
    |                    | Идентификатор приложения, выдается при регистрации приложения.                   |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | client_secret      | Обязательный параметр. |br|                                                      |
    |                    | Ключ приложения, выдается при регистрации приложения.                            |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | redirect_uri       | Обязательный параметр. |br|                                                      |
    |                    | URL, на который получили код подтверждения.                                      |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 400                                       |
    +--------------------+----------------------------------------------------------------------------------+

**Пример запроса**

::

    POST /token
    Content-type: application/x-www-form-urlencoded
    
    grant_type=authorization_code
    code=SplxlOBeZQQYbYS6WxSbIA
    client_id=yourClientId
    client_secret=yourClientSecret
    redirect_uri=http://client.example.com

7. Если запрос успешно выполнен, OpenID Провайдер возвращает в ответ Id Token и Access Token. Если OpenID Провайдер не смог выдать токен, то он вернет ответ с ошибкой. Формат ответа — JSON.

   Время жизни Id Token — 5 минут, но OpenID Провайдер не гарантирует, что данные пользователя не изменятся за это время. Для получения информации о пользователе приложение может обратиться к :doc:`UserInfo Endpoint</schemes/discovery>`.

.. rubric::  Параметры ответа Token Endpoint

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | id_token           | Токен идентификации — Id Token, запрошенный приложением.                         |
    |                    | Данный параметр можно использовать |br| для проверки личности пользователя       |
    +--------------------+----------------------------------------------------------------------------------+
    | access_token       | Access Token можно использовать для обращения к UserInfo Endpoint                |
    +--------------------+----------------------------------------------------------------------------------+
    | token_type         | Тип токена. Всегда возвращает значение ``Bearer``                                |
    +--------------------+----------------------------------------------------------------------------------+
    | expires_in         | Время жизни Access Token в секундах                                              |
    +--------------------+----------------------------------------------------------------------------------+

.. rubric:: Возможные ошибки Token Endpoint

.. table::

    +-----+------------------------+----------------------------------------------------------------------------+
    | Код | Название ошибки        | Описание                                                                   |
    +=====+========================+============================================================================+
    | 400 | invalid_client         | * Параметр client_secret или client_id не передан;                         |
    |     |                        | * Параметр client_secret или client_id превышает 300 символов              |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | unsupported_grant_type | * Параметр grant_type не передан;                                          |
    |     |                        | * Переданный grant_type не существует;                                     |
    |     |                        | * Для указанного клиента client_id запрещен переданный grant_type;         |
    |     |                        |                                                                            |
    |     |                        | Если вы хотите реализовать текущую схему аутентификации, напишите нам |br| |
    |     |                        | на portal.team@skbkontur.ru и опишите ваш сценарий                         |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | invalid_grant          | * Параметр authorization_code не передан;                                  |
    |     |                        | * Передан неверный код подтверждения;                                      |
    |     |                        | * Время жизни кода подтверждения истекло;                                  |
    |     |                        | * Переданный authorization_code был выпущен для другого client_id;         |
    |     |                        |                                                                            |
    |     |                        | (т.е. аутентификацию начинал другой сервис)                                |
    +-----+------------------------+----------------------------------------------------------------------------+
    | 400 | unauthorized_client    | * Для указанного клиента client_id запрещен переданный authorization_code; |
    |     |                        | * Параметр redirect_uri не передан;                                        |
    |     |                        | * Передан неправильный redirect_uri;                                       |
    |     |                        |                                                                            |
    |     |                        | (код подтверждения был отправлен на другой redirect_uri)                   |
    +-----+------------------------+----------------------------------------------------------------------------+


**Пример ответа**

::

    200 OK
    Content-type: application/json
    
    {
    "access_token": "AAAAAAAAAAAAAAAAA",
    "token_type": "Bearer",
    "expires_in": 3600,
    "id_token": "eyJhbGciOifQ.ewogI3pAKfQ.ggW8hq-rvKMzqg"
    }

8. Бэкенд получает из Id Token информацию о пользователе. Для проверки Id Token воспользуйтесь :doc:`открытым ключом OpenID Provider</schemes/discovery>`. 

9. Бэкенд передает информацию о пользователе из Id Token на фронтенд приложения.


.. note:: Вы должны самостоятельно решить, как будете хранить информацию о сессии пользователя в своём продукте. Например, можно использовать Cookie или LocalStorage браузера.


Получение токена из URL
-----------------------

см. в `RFC Implicit Flow`_

Схема подходит для одностраничных приложений без серверной части. Пользователь для входа в ваше приложение использует учетную запись Контура. 

На схеме ниже показаны основные этапы входа в приложение. Каждый этап описан в алгоритме.

.. image:: /_static/authentication_by_url.JPG

**Алгоритм получения токена из URL**

Чтобы инициировать аутентификацию в приложении должна быть кнопка/ссылка "Войти".

1. Пользователь входит в приложение.

2. Приложение направляет пользователя на OpenID Провайдер. Для этого нужно перенаправить пользователя на Authorization Endpoint:

.. rubric:: Параметры Authorization Endpoint

Все параметры типа string

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | response_type      | Обязательный параметр. |br|                                                      |
    |                    | Ответ, который нужно получить от OpenID Провайдера. |br|                         |
    |                    | При запросе кода подтверждения указать значение ``id_token token`` |br|          |
    +--------------------+----------------------------------------------------------------------------------+
    | client_id          | Обязательный параметр. |br|                                                      |
    |                    | Идентификатор приложения, выдается при регистрации приложения |br|               |
    +--------------------+----------------------------------------------------------------------------------+
    | scope              | Обязательный параметр. |br|                                                      |
    |                    | Список прав доступа, которые необходимы приложению в текущей сессии. |br|        |
    |                    | Разделяются пробелом.  |br|                                                      |
    |                    |                                                                                  |
    |                    | * openid — обязательный scope для аутентификации. |br|                           |
    |                    |                                                                                  |
    |                    | Данный скоуп предполагает получение в ответ от OpenID Провайдера Id Token. |br|  |
    |                    |                                                                                  |
    |                    | Вместе со скоупом openid вы можете передать:                                     |
    |                    |                                                                                  |
    |                    | * profile;                                                                       |
    |                    | * email;                                                                         |
    |                    | * phone.                                                                         |
    |                    |                                                                                  |
    |                    | Описание данных скоупов, а также полный список прав доступов |br|                |
    |                    | см. в :ref:`Терминах и определениях<rst-murkup-scope>`.  |br|                    |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | redirect_uri       | Обязательный параметр. |br|                                                      |
    |                    | URL, на который нужно перенаправить пользователя после того, как он |br|         |
    |                    | аутентифицировался. |br|                                                         |
    |                    | |br|                                                                             |
    |                    | Адрес URL, который будет передан в данном параметре, нужно обязательно |br|      |
    |                    | указать при :ref:`регистрации приложения<rst-murkup-registration>`               |
    |                    | до выполнения запроса.  |br|                                                     |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 400                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | nonce              | Обязательный параметр. |br|                                                      |
    |                    | Строка для удостоверения, что сессия клиента связана именно с вернувшимся |br|   |
    |                    | Id Token, и для предотвращения атак повторного воспроизведения.  |br|            |
    |                    | Данная строка вернется обратно клиенту внутри Id Token в п.7. |br|               |
    |                    | |br|                                                                             |
    |                    | Использование nonce позволит вам проверить подлинность информации, |br|          |
    |                    | которую вы получите в Id Token от OpenID Провайдера.                             |
    |                    |                                                                                  |
    |                    | Максимальная допустимая длина строки — 300                                       |
    +--------------------+----------------------------------------------------------------------------------+
    | state              | Необязательный параметр.  |br|                                                   |
    |                    | Строка состояния. Параметр state служит для передачи пользовательского |br|      |
    |                    | контекста. |br|                                                                  |
    |                    | |br|                                                                             |
    |                    | State вернется без изменений обратно клиенту вместе с кодом подтверждения  |br|  |
    |                    | в п.4. Таким образом, вы можете сохранить данные и состояние |br|                |
    |                    | пользователя, созданные до, и  восстановить их после аутентификации. |br|        |
    |                    | |br|                                                                             |
    |                    | Максимальная допустимая длина строки — 1500                                      |
    +--------------------+----------------------------------------------------------------------------------+

**Пример запроса**

:: 

    https://identity.testkontur.ru/authorize?
    response_type=id_token token
    &scope=openid profile email
    &client_id=s6BhdRkqt3
    &redirect_uri=https://client.example.com
    &nonce=n-0S6_WzA2Mj
    &state=af0ifjsldkj

3. OpenID Провайдер перенаправляет пользователя на `страницу входа`_, где он входит в существующую учетную запись или регистрирует новую.

4. OpenID Провайдер перенаправляет пользователя на адрес, указанный в поле ``redirect_uri``. В URL перенаправления будет передан код подтверждения. Если код подтверждения выдать не удалось, то OpenID Провайдер передаст в URL код ошибки и ее описание. 

   Время жизни Id Token — 5 минут, но OpenID Провайдер не гарантирует, что данные пользователя не изменятся за это время. Для получения информации о пользователе приложение может обратиться к :doc:`UserInfo Endpoint</schemes/discovery>`.

.. note:: Есть такие ошибки, которые пользователь увидит в браузере, но они не вернутся приложению в ответе от Authorization Endpoint. Для пользователя на этом закончится сценарий аутентификации. OpenID Провайдер не будет перенаправлять его на redirect_uri. Примеры и описание на странице :doc:`/schemes/user_errors`.

.. rubric:: Данные в URL

.. table::

    +--------------------+----------------------------------------------------------------------------------+
    | Параметр           | Описание                                                                         |
    +====================+==================================================================================+
    | token_type         | Тип токена. Всегда возвращает значение ``Bearer``                                |
    +--------------------+----------------------------------------------------------------------------------+
    | id_token           | Токен идентификации — Id Token, запрошенный приложением.                         |
    |                    | Можно использовать параметр |br| для проверки личности пользователя              |
    +--------------------+----------------------------------------------------------------------------------+
    | access_token       | Access Token можно использовать для обращения к UserInfo Endpoint                |
    +--------------------+----------------------------------------------------------------------------------+
    | expires_in         | Время жизни Access Token в секундах                                              |
    +--------------------+----------------------------------------------------------------------------------+
    | state              | Строка состояния, которую OpenID Провайдер возвращает без изменения              |
    +--------------------+----------------------------------------------------------------------------------+
    | error              | Ошибка аутентификации **access_denied**. Возвращается вместо кода |br|           |
    |                    | подтверждения, если пользователь или сервер по какой-то причине не выдал |br|    |
    |                    | разрешение на доступ к данным                                                    |
    +--------------------+----------------------------------------------------------------------------------+
    | error_description  | Описание ошибки                                                                  |
    +--------------------+----------------------------------------------------------------------------------+

**Пример ответа с Id Token**

::

    HTTP/1.1 302 Found
    Location: https://client.example.com?
    access_token=SlAV32hkKG
    &token_type=bearer
    &id_token=eyJ0NiJ9.eyJ1I6IjIifX0.DeWt4QuZXso
    &expires_in=3600
    &state=af0ifjsldkj

**Пример ответа с ошибкой**

::

    HTTP/1.1 302 Found
    Location: https://client.example.com?
    error=access_denied
    &state=af0ifjsldkj

5. Приложение получает из Id Token информацию о пользователе. Для проверки Id Token воспользуйтесь :doc:`открытым ключом OpenID Provider</schemes/discovery>`. 

.. note:: Вы должны самостоятельно решить, как будете хранить информацию о сессии пользователя в своём продукте. Например, можно использовать Cookie или LocalStorage браузера.
