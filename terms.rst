Термины и определения
=====================

* `Аутентификация`_
* `Авторизация`_
* `Пользователь`_
* `Приложение`_
* `Провайдер`_
* `Сервер ресурсов`_
* `Id Token`_
* `Access Token`_
* `Refresh Token`_

Аутентификация
--------------

Под аутентификацией понимаем подтверждение личности пользователя и его свойств, например, ФИО, email, телефон и т.д. 

Авторизация
-----------

Авторизация — процесс проверки наличия прав на выполнение операции у того, кто инициирует выполнение операции.

Пользователь
------------

Конечный пользователь вашего приложения. Это сторона, которая владеет данными и принимает решение о предоставлении доступа к персональным данным. Только пользователь может дать разрешение на чтение своих данных из продуктов Контура для вашего приложения. 

Приложение
----------

Это ваше веб приложение (далее — приложение), определяемое идентификатором client_id, который выдается после регистрации приложения. В RFC определяется как клиент. Именно с этой стороной взаимодействует конечный пользователь. 

OpenID Connect умеет взаимодействовать с двумя типами приложений: с бэкендом и без. 

.. _rst-murkup-provider:

Провайдер
---------

OpenID Provider (далее — OpenID Провайдер) — аутентификационный сервер, который реализует протокол OpenID Connect. Он отвечает за идентификацию пользователя, предоставление и отзыв токенов.

Провайдер имеет открытый и закрытый ключи.

RFC OpenID Connect 1.0.

Адреса для отправки запросов к OpenID Провайдеру:

* Рабочая площадка: http://identity.kontur.ru/connect/
* Тестовая площадка: http://identity.testkontur.ru/connect/ 

Сервер ресурсов
---------------

Сервер ресурсов — это место размещения ресурса. Предоставляет приложению доступ к ресурсу, как правило это API с авторизацией по схеме Bearer. 

.. _rst-murkup-idtoken:

Id Token
--------

Id Token — токен с информацией о пользователе, с помощью которого можно аутентифицировать пользователя. Формат токена — JSON Web Token (JWT).

При выдаче токена OpenID Провайдер подписывает Id Token закрытым ключом. Проверить, что токен выдан именно OpenID Провайдером, можно с помощью открытого ключа, который лежит в публичном доступе.

Время жизни ID Tokena 5 минут. 

**Информация в токене**

.. _rst-murkup-scope:

Scope
~~~~~

Scope — параметр, определяющий, какой доступ нужен приложению. Это может быть доступ к информации о пользователе, различным данным или действиям в API. Приложение указывает параметр scope при запросе токенов. Все доступные scope можно найти в документе метаданных в поле ``scopes_supported``.

Список общих scope:

* profile — основная информация о пользователе;
* email — email пользователя;
* phone — телефон пользователя;
* openid — scope аутентификации, дает доступ к Id Token;
* offline_access — доступ к Refresh Token.

У каждого API Контура может быть свой набор scope, если они зарегистрированы в OpenID Провайдере. Разрешение на их использование выдают владельцы API продуктов Контура.

Данные, к которым дает доступ scope, зашиты в claim.

Claim
~~~~~
Claim — параметр, в котором содержится информация о пользователе. Представляется в виде пары имя/значение.

Таблица ниже показывает, какие claim'ы можно получить, указав в запросе определенный scope. 

.. |br| raw:: html

    <br />

.. table::

    +-----------------------+-----------------------+-----------------------------------------------------+
    | Scope из запроса |br| | Claim                 | Значение claim                                      |
    | получения токена      |                       |                                                     |
    +=======================+=======================+=====================================================+
    |                       | sub                   | Идентификатор пользователя. Это базовый claim, |br| |
    |                       |                       | который есть у всех пользовательских токенов        |
    +-----------------------+-----------------------+-----------------------------------------------------+
    | profile               | given_name            | Имя                                                 |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | family_name           | Фамилия                                             |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | middle_name           | Отчество                                            |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | name                  | ФИО полностью                                       |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | updated_at            | Время последнего изменения профиля пользователя     |
    +-----------------------+-----------------------+-----------------------------------------------------+
    | email                 | email                 | E-mail                                              |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | email_verified        | Принимает значение true всегда, когда указан email  |
    +-----------------------+-----------------------+-----------------------------------------------------+
    | phone                 | phone_number          | Телефон                                             |
    +-----------------------+-----------------------+-----------------------------------------------------+
    |                       | phone_number_verified | Принимает значение true всегда, когда указан |br|   |
    |                       |                       | phone_number                                        |
    +-----------------------+-----------------------+-----------------------------------------------------+

В таблице описаны claim'ы только для стандартных scope. Если вы хотите передать scope какого-либо продукта Контура, для них будут определены свои claim'ы. Их вы можете узнать при регистрации приложения.

.. _rst-murkup-acesstoken:

Access Token
------------
Access Token — токен доступа. Некоторый идентификатор, который не содержит информацию. Этот токен используется для того, чтобы совершать действия от имени пользователя в API продукта Контура. Формат токена — reference token.

Авторизация с Access токеном, выпущенным OpenId Провайдером, возможна только в API продуктов Контура, которые принимают запросы с HTTP заголовком Authorization: Bearer. 

Время жизни Access Token 24 часа. 

.. _rst-murkup-refreshtoken:

Refresh Token
-------------
Refresh Token — идентификатор, который содержит информацию, необходимую для получения нового Access Token без взаимодействия с пользователем. Нужен для получения постоянного доступа к данным пользователя, когда он уже закрыл браузер или не работает в вашем приложении.

По умолчанию вместе с Access Token создается новый Refresh Token.

Срок жизни Refresh Token составляет 15 дней.